{"ast":null,"code":"\"use strict\";\n\nvar _objectSpread = require(\"/Users/taykim/Desktop/cs98/cs98_fall_demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/objectSpread2.js\").default;\nvar _taggedTemplateLiteral = require(\"/Users/taykim/Desktop/cs98/cs98_fall_demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/taggedTemplateLiteral.js\").default;\nvar _createClass = require(\"/Users/taykim/Desktop/cs98/cs98_fall_demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass.js\").default;\nvar _classCallCheck = require(\"/Users/taykim/Desktop/cs98/cs98_fall_demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\nvar _inherits = require(\"/Users/taykim/Desktop/cs98/cs98_fall_demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/inherits.js\").default;\nvar _createSuper = require(\"/Users/taykim/Desktop/cs98/cs98_fall_demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createSuper.js\").default;\nvar _wrapNativeSuper = require(\"/Users/taykim/Desktop/cs98/cs98_fall_demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/wrapNativeSuper.js\").default;\nvar _templateObject, _templateObject2, _templateObject3, _templateObject4, _templateObject5;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ValueScope = exports.ValueScopeName = exports.Scope = exports.varKinds = exports.UsedValueState = void 0;\nvar code_1 = require(\"./code\");\nvar ValueError = /*#__PURE__*/function (_Error) {\n  _inherits(ValueError, _Error);\n  var _super = _createSuper(ValueError);\n  function ValueError(name) {\n    var _this;\n    _classCallCheck(this, ValueError);\n    _this = _super.call(this, \"CodeGen: \\\"code\\\" for \".concat(name, \" not defined\"));\n    _this.value = name.value;\n    return _this;\n  }\n  return _createClass(ValueError);\n}( /*#__PURE__*/_wrapNativeSuper(Error));\nvar UsedValueState;\n(function (UsedValueState) {\n  UsedValueState[UsedValueState[\"Started\"] = 0] = \"Started\";\n  UsedValueState[UsedValueState[\"Completed\"] = 1] = \"Completed\";\n})(UsedValueState = exports.UsedValueState || (exports.UsedValueState = {}));\nexports.varKinds = {\n  const: new code_1.Name(\"const\"),\n  let: new code_1.Name(\"let\"),\n  var: new code_1.Name(\"var\")\n};\nvar Scope = /*#__PURE__*/function () {\n  function Scope() {\n    var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},\n      prefixes = _ref.prefixes,\n      parent = _ref.parent;\n    _classCallCheck(this, Scope);\n    this._names = {};\n    this._prefixes = prefixes;\n    this._parent = parent;\n  }\n  _createClass(Scope, [{\n    key: \"toName\",\n    value: function toName(nameOrPrefix) {\n      return nameOrPrefix instanceof code_1.Name ? nameOrPrefix : this.name(nameOrPrefix);\n    }\n  }, {\n    key: \"name\",\n    value: function name(prefix) {\n      return new code_1.Name(this._newName(prefix));\n    }\n  }, {\n    key: \"_newName\",\n    value: function _newName(prefix) {\n      var ng = this._names[prefix] || this._nameGroup(prefix);\n      return \"\".concat(prefix).concat(ng.index++);\n    }\n  }, {\n    key: \"_nameGroup\",\n    value: function _nameGroup(prefix) {\n      var _a, _b;\n      if (((_b = (_a = this._parent) === null || _a === void 0 ? void 0 : _a._prefixes) === null || _b === void 0 ? void 0 : _b.has(prefix)) || this._prefixes && !this._prefixes.has(prefix)) {\n        throw new Error(\"CodeGen: prefix \\\"\".concat(prefix, \"\\\" is not allowed in this scope\"));\n      }\n      return this._names[prefix] = {\n        prefix: prefix,\n        index: 0\n      };\n    }\n  }]);\n  return Scope;\n}();\nexports.Scope = Scope;\nvar ValueScopeName = /*#__PURE__*/function (_code_1$Name) {\n  _inherits(ValueScopeName, _code_1$Name);\n  var _super2 = _createSuper(ValueScopeName);\n  function ValueScopeName(prefix, nameStr) {\n    var _this2;\n    _classCallCheck(this, ValueScopeName);\n    _this2 = _super2.call(this, nameStr);\n    _this2.prefix = prefix;\n    return _this2;\n  }\n  _createClass(ValueScopeName, [{\n    key: \"setValue\",\n    value: function setValue(value, _ref2) {\n      var property = _ref2.property,\n        itemIndex = _ref2.itemIndex;\n      this.value = value;\n      this.scopePath = (0, code_1._)(_templateObject || (_templateObject = _taggedTemplateLiteral([\".\", \"[\", \"]\"])), new code_1.Name(property), itemIndex);\n    }\n  }]);\n  return ValueScopeName;\n}(code_1.Name);\nexports.ValueScopeName = ValueScopeName;\nvar line = (0, code_1._)(_templateObject2 || (_templateObject2 = _taggedTemplateLiteral([\"\\n\"], [\"\\\\n\"])));\nvar ValueScope = /*#__PURE__*/function (_Scope) {\n  _inherits(ValueScope, _Scope);\n  var _super3 = _createSuper(ValueScope);\n  function ValueScope(opts) {\n    var _this3;\n    _classCallCheck(this, ValueScope);\n    _this3 = _super3.call(this, opts);\n    _this3._values = {};\n    _this3._scope = opts.scope;\n    _this3.opts = _objectSpread(_objectSpread({}, opts), {}, {\n      _n: opts.lines ? line : code_1.nil\n    });\n    return _this3;\n  }\n  _createClass(ValueScope, [{\n    key: \"get\",\n    value: function get() {\n      return this._scope;\n    }\n  }, {\n    key: \"name\",\n    value: function name(prefix) {\n      return new ValueScopeName(prefix, this._newName(prefix));\n    }\n  }, {\n    key: \"value\",\n    value: function value(nameOrPrefix, _value) {\n      var _a;\n      if (_value.ref === undefined) throw new Error(\"CodeGen: ref must be passed in value\");\n      var name = this.toName(nameOrPrefix);\n      var prefix = name.prefix;\n      var valueKey = (_a = _value.key) !== null && _a !== void 0 ? _a : _value.ref;\n      var vs = this._values[prefix];\n      if (vs) {\n        var _name = vs.get(valueKey);\n        if (_name) return _name;\n      } else {\n        vs = this._values[prefix] = new Map();\n      }\n      vs.set(valueKey, name);\n      var s = this._scope[prefix] || (this._scope[prefix] = []);\n      var itemIndex = s.length;\n      s[itemIndex] = _value.ref;\n      name.setValue(_value, {\n        property: prefix,\n        itemIndex: itemIndex\n      });\n      return name;\n    }\n  }, {\n    key: \"getValue\",\n    value: function getValue(prefix, keyOrRef) {\n      var vs = this._values[prefix];\n      if (!vs) return;\n      return vs.get(keyOrRef);\n    }\n  }, {\n    key: \"scopeRefs\",\n    value: function scopeRefs(scopeName) {\n      var values = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this._values;\n      return this._reduceValues(values, function (name) {\n        if (name.scopePath === undefined) throw new Error(\"CodeGen: name \\\"\".concat(name, \"\\\" has no value\"));\n        return (0, code_1._)(_templateObject3 || (_templateObject3 = _taggedTemplateLiteral([\"\", \"\", \"\"])), scopeName, name.scopePath);\n      });\n    }\n  }, {\n    key: \"scopeCode\",\n    value: function scopeCode() {\n      var values = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this._values;\n      var usedValues = arguments.length > 1 ? arguments[1] : undefined;\n      var getCode = arguments.length > 2 ? arguments[2] : undefined;\n      return this._reduceValues(values, function (name) {\n        if (name.value === undefined) throw new Error(\"CodeGen: name \\\"\".concat(name, \"\\\" has no value\"));\n        return name.value.code;\n      }, usedValues, getCode);\n    }\n  }, {\n    key: \"_reduceValues\",\n    value: function _reduceValues(values, valueCode) {\n      var _this4 = this;\n      var usedValues = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n      var getCode = arguments.length > 3 ? arguments[3] : undefined;\n      var code = code_1.nil;\n      var _loop = function _loop(prefix) {\n        var vs = values[prefix];\n        if (!vs) return \"continue\";\n        var nameSet = usedValues[prefix] = usedValues[prefix] || new Map();\n        vs.forEach(function (name) {\n          if (nameSet.has(name)) return;\n          nameSet.set(name, UsedValueState.Started);\n          var c = valueCode(name);\n          if (c) {\n            var def = _this4.opts.es5 ? exports.varKinds.var : exports.varKinds.const;\n            code = (0, code_1._)(_templateObject4 || (_templateObject4 = _taggedTemplateLiteral([\"\", \"\", \" \", \" = \", \";\", \"\"])), code, def, name, c, _this4.opts._n);\n          } else if (c = getCode === null || getCode === void 0 ? void 0 : getCode(name)) {\n            code = (0, code_1._)(_templateObject5 || (_templateObject5 = _taggedTemplateLiteral([\"\", \"\", \"\", \"\"])), code, c, _this4.opts._n);\n          } else {\n            throw new ValueError(name);\n          }\n          nameSet.set(name, UsedValueState.Completed);\n        });\n      };\n      for (var prefix in values) {\n        var _ret = _loop(prefix);\n        if (_ret === \"continue\") continue;\n      }\n      return code;\n    }\n  }]);\n  return ValueScope;\n}(Scope);\nexports.ValueScope = ValueScope;","map":{"version":3,"sources":["../../../lib/compile/codegen/scope.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.ValueScope = exports.ValueScopeName = exports.Scope = exports.varKinds = exports.UsedValueState = void 0;\nconst code_1 = require(\"./code\");\nclass ValueError extends Error {\n    constructor(name) {\n        super(`CodeGen: \"code\" for ${name} not defined`);\n        this.value = name.value;\n    }\n}\nvar UsedValueState;\n(function (UsedValueState) {\n    UsedValueState[UsedValueState[\"Started\"] = 0] = \"Started\";\n    UsedValueState[UsedValueState[\"Completed\"] = 1] = \"Completed\";\n})(UsedValueState = exports.UsedValueState || (exports.UsedValueState = {}));\nexports.varKinds = {\n    const: new code_1.Name(\"const\"),\n    let: new code_1.Name(\"let\"),\n    var: new code_1.Name(\"var\"),\n};\nclass Scope {\n    constructor({ prefixes, parent } = {}) {\n        this._names = {};\n        this._prefixes = prefixes;\n        this._parent = parent;\n    }\n    toName(nameOrPrefix) {\n        return nameOrPrefix instanceof code_1.Name ? nameOrPrefix : this.name(nameOrPrefix);\n    }\n    name(prefix) {\n        return new code_1.Name(this._newName(prefix));\n    }\n    _newName(prefix) {\n        const ng = this._names[prefix] || this._nameGroup(prefix);\n        return `${prefix}${ng.index++}`;\n    }\n    _nameGroup(prefix) {\n        var _a, _b;\n        if (((_b = (_a = this._parent) === null || _a === void 0 ? void 0 : _a._prefixes) === null || _b === void 0 ? void 0 : _b.has(prefix)) || (this._prefixes && !this._prefixes.has(prefix))) {\n            throw new Error(`CodeGen: prefix \"${prefix}\" is not allowed in this scope`);\n        }\n        return (this._names[prefix] = { prefix, index: 0 });\n    }\n}\nexports.Scope = Scope;\nclass ValueScopeName extends code_1.Name {\n    constructor(prefix, nameStr) {\n        super(nameStr);\n        this.prefix = prefix;\n    }\n    setValue(value, { property, itemIndex }) {\n        this.value = value;\n        this.scopePath = (0, code_1._) `.${new code_1.Name(property)}[${itemIndex}]`;\n    }\n}\nexports.ValueScopeName = ValueScopeName;\nconst line = (0, code_1._) `\\n`;\nclass ValueScope extends Scope {\n    constructor(opts) {\n        super(opts);\n        this._values = {};\n        this._scope = opts.scope;\n        this.opts = { ...opts, _n: opts.lines ? line : code_1.nil };\n    }\n    get() {\n        return this._scope;\n    }\n    name(prefix) {\n        return new ValueScopeName(prefix, this._newName(prefix));\n    }\n    value(nameOrPrefix, value) {\n        var _a;\n        if (value.ref === undefined)\n            throw new Error(\"CodeGen: ref must be passed in value\");\n        const name = this.toName(nameOrPrefix);\n        const { prefix } = name;\n        const valueKey = (_a = value.key) !== null && _a !== void 0 ? _a : value.ref;\n        let vs = this._values[prefix];\n        if (vs) {\n            const _name = vs.get(valueKey);\n            if (_name)\n                return _name;\n        }\n        else {\n            vs = this._values[prefix] = new Map();\n        }\n        vs.set(valueKey, name);\n        const s = this._scope[prefix] || (this._scope[prefix] = []);\n        const itemIndex = s.length;\n        s[itemIndex] = value.ref;\n        name.setValue(value, { property: prefix, itemIndex });\n        return name;\n    }\n    getValue(prefix, keyOrRef) {\n        const vs = this._values[prefix];\n        if (!vs)\n            return;\n        return vs.get(keyOrRef);\n    }\n    scopeRefs(scopeName, values = this._values) {\n        return this._reduceValues(values, (name) => {\n            if (name.scopePath === undefined)\n                throw new Error(`CodeGen: name \"${name}\" has no value`);\n            return (0, code_1._) `${scopeName}${name.scopePath}`;\n        });\n    }\n    scopeCode(values = this._values, usedValues, getCode) {\n        return this._reduceValues(values, (name) => {\n            if (name.value === undefined)\n                throw new Error(`CodeGen: name \"${name}\" has no value`);\n            return name.value.code;\n        }, usedValues, getCode);\n    }\n    _reduceValues(values, valueCode, usedValues = {}, getCode) {\n        let code = code_1.nil;\n        for (const prefix in values) {\n            const vs = values[prefix];\n            if (!vs)\n                continue;\n            const nameSet = (usedValues[prefix] = usedValues[prefix] || new Map());\n            vs.forEach((name) => {\n                if (nameSet.has(name))\n                    return;\n                nameSet.set(name, UsedValueState.Started);\n                let c = valueCode(name);\n                if (c) {\n                    const def = this.opts.es5 ? exports.varKinds.var : exports.varKinds.const;\n                    code = (0, code_1._) `${code}${def} ${name} = ${c};${this.opts._n}`;\n                }\n                else if ((c = getCode === null || getCode === void 0 ? void 0 : getCode(name))) {\n                    code = (0, code_1._) `${code}${c}${this.opts._n}`;\n                }\n                else {\n                    throw new ValueError(name);\n                }\n                nameSet.set(name, UsedValueState.Completed);\n            });\n        }\n        return code;\n    }\n}\nexports.ValueScope = ValueScope;\n//# sourceMappingURL=scope.js.map"]},"metadata":{},"sourceType":"script"}